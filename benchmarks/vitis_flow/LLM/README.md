<!--
Copyright (c) 2024 RapidStream Design Automation, Inc. and contributors.  All rights reserved.
The contributor(s) of this file has/have agreed to the RapidStream Contributor License Agreement.
-->

<img src="https://imagedelivery.net/AU8IzMTGgpVmEBfwPILIgw/1b565657-df33-41f9-f29e-0d539743e700/128" width="64px" alt="RapidStream Logo" />

# Large Language Model Benchmark

## Introduction

In this recipe, we illustrate how to create a Vitis objective file (`.xo`) for a Large Language Model kernel from [Chen *et al.* (TRETS)](https://dl.acm.org/doi/10.1145/3656177) using Vitis, then optimize the `.xo` file with Rapidstream, and finally utilize the optimized output in the ongoing Vitis development process.


## Tutorial

### Step 1: Generate the Xilinx Object File (`.xo`)

We use Vitis 2023.2 to generate the `.xo` file. Since we want to disable [free running pipeline (FRP)](https://www.xilinx.com/htmldocs/xilinx2021_2/hls-guidance/200-1553.html) feature for HLS step, we use [hls2rtl.tcl](../../../common/tcl/hls2rtl.tcl) to compile the C++ code to `.xo` file.

Run the following command or run `make clean && make xo`:

```bash
source <Vitis_install_path>/Vitis/2023.2/settings64.sh
make clean
mkdir -p build
vitis_hls ../../../common/tcl/hls2rtl.tcl \
  -l build/vitis_hls_llm.log \
  -tclargs \
  xcu50-fsvh2104-2-e \
  4 \
  bert_all \
  1 \
  design/bert_all.cpp design/kernel.h \
  design/bert_region_1.cpp design/bert_region_1.h \
  design/bert_region_2.cpp design/bert_region_2.h \
  design/bert_region_3.cpp design/bert_region_3.h
```

### Step 2 (Optional): Use Vitis --link to Generate the `.xclbin` File

:warning: **Note**: This step can take hours to complete. We recommend using the RapidStream flow to optimize the `.xo` file instead of generating the `.xclbin` file if you are familiar with AMD Vitis flow.

With the `.xo` file generated, you can use `v++ -link` to generate the `.xclbin` file. Run the following command or execute `make hw`:

```bash
v++ -l -t hw \
  --platform xilinx_u50_gen3x16_xdma_5_202210_1 \
  --kernel bert_all \
  --connectivity.nk bert_all:1:bert_all \
  --config design/link_config_hbm.ini \
  --temp_dir build \
  -o build/bert_all.xclbin \
  build/bert_all.xo
```

### Step 3: Call RapidStream to Optimize the Design

The RapidStream flow conducts design space exploration and generates optimized `.xo` files by taking the Vitis generated `.xo` as the input. The RapidStream flow for Vitis requires four key inputs:

1. **Device**: Specify the Vitis platform name for `v++`.
2. **Xilinx Object file** (.xo): Provide the file generated by `v++` or Vivado.
3. **Connectivity** (.ini): Include the configuration file for `v++` ([link_config_hbm.ini](./design/link_config_hbm.ini)).
4. **Clock targets**: Define the desired clock frequencies.
5. RapidStream automatically handles all other aspects of the flow.

Please refer to [run_u50.py](./run_u50.py) for the complete RapidStream flow.
To execute the flow and generate optimized `.xo` files,
Run the following command or execute `make rs_opt`:

```bash
rapidstream ./run_u50.py
```

Unlike in the example provided in [getting_started/vitis_source](../../../getting_started/vitis_source/run.py) where the `skip_impl` variable is set to `True`, in this case, the DSE engine will automatically launch Vitis to link the optimized `.xo` file to the target device and generate the `.xclbin` file.

```bash
# Skip Vitis implementation.
rs.run_dse(skip_impl=True)
```

When finished, you can locate these files using the following command:


```bash
find ./build/dse/ -name *.xclbin
```

If everything is successful, you should at least get one optimized `.xclbin` file.


### Step 4: Check the Group Module Report


RapidStream mandates a clear distinction between communication and computation within user designs.

- In `Group modules`, users are tasked solely with defining inter-submodule communication. For those familiar with Vivado IP Integrator flow, crafting a Group module mirrors the process of connecting IPs in IPI. RapidStream subsequently integrates appropriate pipeline registers into these Group modules.

- In `Leaf modules`, users retain the flexibility to implement diverse computational patterns, as RapidStream leaves these Leaf modules unchanged.

For further details, please consult the [code style](https://docs.rapidstream-da.com/required-coding-style/) section in our Documentation.

To generate a report on group types, execute the commands below or `run make show_groups`:

```bash
rapidstream ../../../common/util/get_group.py \
	-i build/passes/0-imported.json \
	-o build/module_types.csv
```

The module types for your design can be found in `build/module_types.csv`. Below, we list the four Group modules. In this design, `VecAdd` serves as a Group module, while the other three modules are added by RapidStream.

| Module Name                      | Group Type     |
|:--------------------------------:|:--------------:|
| bert_all                         | grouped_module |
|__rs_ap_ctrl_start_ready_pipeline | grouped_module |
|__rs_ff_pipeline                  | grouped_module |
|__rs_hs_pipeline                  | grouped_module |


## Other platforms

We also provide scripts to compile this example for various devices as below.


|  Target Device |             Vitis Platform            |            Scripts           |
|:--------------:|:-------------------------------------:|:----------------------------:|
| Alveo U50      |xilinx_u50_gen3x16_xdma_5_202210_1     | [run_u50.py](./run_u50.py)   |
| Alveo U55C     |xilinx_u55c_gen3x16_xdma_3_202210_1    | [run_u55c.py](./run_u55c.py) |
| Alveo U280     |xilinx_u280_gen3x16_xdma_1_202211_1    | [run_u280.py](./run_u280.py) |
| Alveo U250     |xilinx_u250_gen3x16_xdma_4_1_202210_1  | [run_u250.py](./run_u250.py) |


We recommend using the [Makefile](./Makefile) for this purpose. For instance, to map the design to an Alveo U55C, simply update the `PLATFORM` variable in the [Makefile](./Makefile) and run `make all`.

```MAKE
PLATFORM := xilinx_u55c_gen3x16_xdma_3_202210_1
```
