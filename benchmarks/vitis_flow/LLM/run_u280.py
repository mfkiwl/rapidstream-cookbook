"""Getting Started: CNN13x2 in the Vitis flow

This script demonstrates how to optimize a CNN13x2 design in
a Vitis object file. In this example, the object file is generated from the
Vitis_HLS.
"""

__copyright__ = """
Copyright (c) 2024 RapidStream Design Automation, Inc. and contributors.  All rights reserved.
The contributor(s) of this file has/have agreed to the RapidStream Contributor License Agreement.
"""

from rapidstream import get_u280_vitis_device_factory, RapidStreamVitis
import os

CURR_DIR = os.path.dirname(os.path.abspath(__file__))

# Replace with RapidStreamVitis for the  ".xo" files generated by `v++`.
# Create a RapidStream project in the "run" directory:
rs = RapidStreamVitis(f"{CURR_DIR}/build")

# Use the "xilinx_u280_gen3x16_xdma_1_202211_1" platform as the device:
u280_factory = get_u280_vitis_device_factory("xilinx_u280_gen3x16_xdma_1_202211_1")
rs.set_virtual_device(u280_factory.generate_virtual_device())

# Add the design object file (".xo") to the project:
rs.add_xo_file(f"{CURR_DIR}/build/bert_all.xo")

# Specify the Vitis platform and connectivity configuration:
rs.set_vitis_platform("xilinx_u280_gen3x16_xdma_1_202211_1")
rs.set_vitis_connectivity_config(f"{CURR_DIR}/design/link_config_hbm.ini")

# Set the clock target for the design:
rs.add_clock("ap_clk", period_ns=3)

# Bind all ports to HBM 16-31:
rs.assign_port_to_region(".*", "SLOT_X1Y0:SLOT_X1Y0")

# Start the RapidStream optimization process:
rs.run_dse()
